name: Deploy Ubuntu Latest

# Se dÃ©clenche sur push ou pull request sur la branche main
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# Liste des jobs Ã  exÃ©cuter
jobs:
    test:
        # DÃ©marre une image Ubuntu
        runs-on: ubuntu-latest

        # Services nÃ©cessaires : Base de donnÃ©es MySQL 8
        services:
            mysql:
                image: mysql:8
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: livre_test
                ports:
                    - 3306:3306
                options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3

        steps:
            - name: ğŸ“¥ RÃ©cupÃ©rer le code du projet
              uses: actions/checkout@v4

            - name: ğŸ”§ Installer PHP et Composer
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.2  # Modifier selon votre version
                  extensions: mbstring, pdo, pdo_mysql
                  tools: composer:v2

            - name: ğŸ“¦ Installer les dÃ©pendances PHP
              run: composer install --no-interaction --prefer-dist --optimize-autoloader

            - name: ğŸ”„ Configurer l'environnement
              run: |
                  cp .env.test .env
                  echo "DATABASE_URL=mysql://root:root@127.0.0.1:3306/livre_test" >> .env

            - name: ğŸ—„ï¸ Migrer la base de donnÃ©es
              run: php bin/console doctrine:migrations:migrate --no-interaction

            - name: ğŸŒ DÃ©marrer le serveur PHP
              run: php -S 127.0.0.1:8000 -t public &

            - name: ğŸ”§ Installer Node.js et Cypress
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: ğŸ“¦ Installer les dÃ©pendances front-end
              run: npm install

            - name: ğŸ§ª Lancer les tests Cypress
              run: npx cypress run
