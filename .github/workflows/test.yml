name: Deploy Ubuntu Latest

# Se déclenche sur push ou pull request sur la branche main
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# Liste des jobs à exécuter
jobs:
    test:
        # Démarre une image Ubuntu
        runs-on: ubuntu-latest

        # Services nécessaires : Base de données MySQL 8
        services:
            mysql:
                image: mysql:8
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: livre_test
                ports:
                    - 3306:3306
                options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3

        steps:
            - name: 📥 Récupérer le code du projet
              uses: actions/checkout@v4

            - name: 🔧 Installer PHP et Composer
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.2  # Modifier selon votre version
                  extensions: mbstring, pdo, pdo_mysql
                  tools: composer:v2

            - name: 📦 Installer les dépendances PHP
              run: composer install --no-interaction --prefer-dist --optimize-autoloader

            - name: 🔄 Configurer l'environnement
              run: |
                  cp .env.test .env
                  echo "DATABASE_URL=mysql://root:root@127.0.0.1:3306/livre_test" >> .env

            - name: 🗄️ Migrer la base de données
              run: php bin/console doctrine:migrations:migrate --no-interaction

            - name: 🌐 Démarrer le serveur PHP
              run: php -S 127.0.0.1:8000 -t public &

            - name: 🔧 Installer Node.js et Cypress
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: 📦 Installer les dépendances front-end
              run: npm install

            - name: 🧪 Lancer les tests Cypress
              run: npx cypress run
